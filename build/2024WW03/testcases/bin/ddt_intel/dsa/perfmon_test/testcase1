#!/bin/bash -Ex

# Test event category = 'Operations', event = EV_MEM_MOVE
#    Count number of memory move descriptors
#
# Filters:
#
#   According to spec, only WQ filter applies to operations category,
#   but if other filters e.g. sz, eng, tc set incorrectly, they will
#   filter events out.
#
#   Also, current hw bug requires unused filters to be set to 0xff..
#
#   Set FLTCFG_WQ to 0x1 (Filter=WQ, Filter Value=0x1 i.e. WQ0)
#   Set FLTCFG_SZ to 0x7 (Filter=Transfer Size, Filter Value=0x7)
#     bit 0: size 0 - 512B
#     bit 1: size 512B - 2KB
#     bit 2: size 2KB - 4KB
#   Set FLTCFG_ENG to 0x1 (Filter=Engine, Filter Value=0x1 i.e. Eng0)
#   Set FLTCFG_TC to 0x1 (Filter=TC, Filter Value=0x1 i.e. TC0)
#   Set FLTCFG_PGSZ to 0x7 (Filter=PGSZ, Filter Value=0x7)
#     Currently this isn't supported in hw
#     bit 0: size 4K
#     bit 1: size 2M
#     bit 2: size 1G
#
# Setup:
#   assumes setup_dsa_dmatest_disabled has been run

# Expected output (similar to):

perf stat -o $1 -e dsa0/filter_wq=0x1,filter_tc=0x1,filter_sz=0x7,filter_eng=0x1,event=0x8,event_category=0x3/ dsa_test -w 1 -l 1024 -o0x3 -t200

# Performance counter stats for 'system wide':

#                19      dsa0/filter_wq=0x1,filter_tc=0x1,filter_sz=0x7,filter_eng=0x1,event=0x8,event_category=0x3/      

#      27.497920161 seconds time elapsed
