# @name Ethernet performance using IPERF
# @desc Run Iperf as a server in a host PC and as a client in the target machine
# Test different window sizes, from 8K to 128K
# @requires eth
# @utility_requires ethtool udhcpc iperf
# TODO: don't hardcode eth0 here. may move ethtool command to script
ETH_S_PERF_IPERF_8K_1448B source 'eth_common.sh'; run_iperf.sh -m -M 1500 -f M -d -t 60 -w 8K
ETH_S_PERF_IPERF_256K_1448B source 'eth_common.sh'; run_iperf.sh -m -M 1500 -f M -d -t 60 -w 256K

ETH_S_PERF_IPERF_8K_76B source 'eth_common.sh'; run_iperf.sh -m -M 88 -f M -d -t 60 -w 8K
ETH_S_PERF_IPERF_256K_76B source 'eth_common.sh'; run_iperf.sh -m -M 88 -f M -d -t 60 -w 256K


ETH_S_PERF_IPERF_8K_200B source 'eth_common.sh'; run_iperf.sh -m -M 212 -f M -d -t 60 -w 8K
ETH_S_PERF_IPERF_256K_200B source 'eth_common.sh'; run_iperf.sh -m -M 212 -f M -d -t 60 -w 256K


ETH_S_PERF_IPERF_INTPAC_8K_1448B source 'eth_common.sh'; iface=`get_eth_iface_name.sh` || (test_print_trc "error getting eth interface name"; exit 2); do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 500"; run_iperf.sh -m -M 1500 -f M -d -t 60 -w 8K; do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 16"
ETH_S_PERF_IPERF_INTPAC_256K_1448B source 'eth_common.sh'; iface=`get_eth_iface_name.sh` || (test_print_trc "error getting eth interface name"; exit 2);  do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 500"; run_iperf.sh -m -M 1500 -f M -d -t 60 -w 256K; do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 16"

ETH_S_PERF_IPERF_INTPAC_8K_76B source 'eth_common.sh'; iface=`get_eth_iface_name.sh` || (test_print_trc "error getting eth interface name"; exit 2);  do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 500"; run_iperf.sh -m -M 88 -f M -d -t 60 -w 8K; do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 16"
ETH_S_PERF_IPERF_INTPAC_256K_76B source 'eth_common.sh'; iface=`get_eth_iface_name.sh` || (test_print_trc "error getting eth interface name"; exit 2);  do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 500"; run_iperf.sh -m -M 88 -f M -d -t 60 -w 256K; do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 16"

ETH_S_PERF_IPERF_INTPAC_8K_200B source 'eth_common.sh'; iface=`get_eth_iface_name.sh` || (test_print_trc "error getting eth interface name"; exit 2);  do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 500"; run_iperf.sh -m -M 212 -f M -d -t 60 -w 8K; do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 16"
ETH_S_PERF_IPERF_INTPAC_256K_200B source 'eth_common.sh'; iface=`get_eth_iface_name.sh` || (test_print_trc "error getting eth interface name"; exit 2);  do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 500"; run_iperf.sh -m -M 212 -f M -d -t 60 -w 256K; do_cmd "set_ethtool_coalesce_options.sh -d $iface -p 'rx-usecs' -n 16"
